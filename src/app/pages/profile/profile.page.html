<app-header></app-header>

<ion-content [fullscreen]="true" class="ion-padding">
  
  <div class="profile-container">
    <!-- Indicador de carga -->
    <ion-spinner *ngIf="loading"></ion-spinner>

    <ion-card class="profile-card" *ngIf="!loading && viewingUser">
      <ion-card-header>
        <div class="profile-header">
          <div class="profile-avatar">
            <ion-icon name="person-outline" size="large"></ion-icon>
          </div>
          <!-- ‚úÖ CAMBIO: Mostrar diferente titulo si es admin viendo otro user -->
          <ion-card-title *ngIf="!isViewingOtherUser">Mi Perfil</ion-card-title>
          <ion-card-title *ngIf="isViewingOtherUser">üë§ {{ viewingUser.username }}</ion-card-title>
        </div>
      </ion-card-header>

      <ion-card-content>
        <ion-list *ngIf="viewingUser">
          
          <!-- RUT (NO editable - siempre readonly) -->
          <ion-item>
            <ion-icon name="card-outline" slot="start"></ion-icon>
            <ion-label position="stacked">RUT</ion-label>
            <ion-input 
              [(ngModel)]="rut" 
              [readonly]="true"
              placeholder="12.345.678-9">
            </ion-input>
          </ion-item>

          <!-- Email (EDITABLE) -->
          <ion-item>
            <ion-icon name="mail-outline" slot="start"></ion-icon>
            <ion-label position="stacked">Email</ion-label>
            <ion-input 
              [(ngModel)]="email" 
              [readonly]="!isEditing"
              placeholder="correo@ejemplo.com">
            </ion-input>
          </ion-item>

          <!-- Username (editable) -->
          <ion-item>
            <ion-icon name="person-outline" slot="start"></ion-icon>
            <ion-label position="stacked">Nombre de usuario</ion-label>
            <ion-input 
              [(ngModel)]="username" 
              [readonly]="!isEditing"
              placeholder="Ingresa tu nombre de usuario">
            </ion-input>
          </ion-item>

          <!-- Contrase√±a actual (solo visible en modo edici√≥n y no admin) -->
          <ion-item *ngIf="isEditing && !isViewingOtherUser">
            <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
            <ion-label position="stacked">Contrase√±a actual (opcional)</ion-label>
            <ion-input 
              [(ngModel)]="currentPassword" 
              type="password"
              placeholder="Ingresa tu contrase√±a actual">
            </ion-input>
          </ion-item>

          <!-- Nueva contrase√±a (solo visible en modo edici√≥n y no admin) -->
          <ion-item *ngIf="isEditing && !isViewingOtherUser">
            <ion-icon name="lock-open-outline" slot="start"></ion-icon>
            <ion-label position="stacked">Nueva contrase√±a (opcional)</ion-label>
            <ion-input 
              [(ngModel)]="newPassword" 
              type="password"
              placeholder="Ingresa tu nueva contrase√±a (m√≠nimo 6 caracteres)">
            </ion-input>
          </ion-item>

          <!-- Regi√≥n (editable) -->
          <ion-item>
            <ion-icon name="location-outline" slot="start"></ion-icon>
            <ion-label position="stacked">Regi√≥n</ion-label>
            <ion-select 
              [(ngModel)]="selectedRegion" 
              [disabled]="!isEditing"
              [class.editable]="isEditing"
              placeholder="Selecciona tu regi√≥n"
              (ionChange)="onRegionChange($event)">
              <ion-select-option *ngFor="let region of regiones" [value]="region">
                {{ region }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Comuna (editable) -->
          <ion-item>
            <ion-icon name="location-outline" slot="start"></ion-icon>
            <ion-label position="stacked">Comuna</ion-label>
            <ion-select 
              [(ngModel)]="selectedComuna" 
              [disabled]="!isEditing"
              [class.editable]="isEditing"
              placeholder="Selecciona tu comuna">
              <ion-select-option *ngFor="let comuna of comunas" [value]="comuna">
                {{ comuna }}
              </ion-select-option>
            </ion-select>
          </ion-item>

        </ion-list>

        <!-- Botones de acci√≥n -->
        <div class="action-buttons">
          <!-- ‚úÖ BOT√ìN EDITAR PERFIL CON COLOR AZUL -->
          <ion-button 
            *ngIf="!isEditing" 
            expand="block" 
            style="
              --background: #3b82f6;
              --background-activated: #2563eb;
              --color: white;
              background: #3b82f6;
              color: white;
              font-weight: 600;
              text-transform: uppercase;
              height: 48px;
            "
            (click)="toggleEdit()">
            ‚úèÔ∏è Editar Perfil
          </ion-button>

          <div *ngIf="isEditing" class="edit-buttons">
            <!-- ‚úÖ BOT√ìN GUARDAR CAMBIOS CON COLOR VERDE -->
            <ion-button 
              expand="block" 
              style="
                --background: #10b981;
                --background-activated: #059669;
                --color: white;
                background: #10b981;
                color: white;
                font-weight: 600;
                text-transform: uppercase;
                height: 48px;
              "
              (click)="onSaveProfile()">
              <ion-icon name="save-outline" slot="start" style="color: white;"></ion-icon>
              Guardar Cambios
            </ion-button>

            <ion-button 
              expand="block" 
              fill="outline"
              color="medium"
              (click)="toggleEdit()">
              Cancelar
            </ion-button>
          </div>

          <!-- ‚úÖ Admin: Bot√≥n eliminar usuario -->
          <ion-button 
            *ngIf="isViewingOtherUser && !isEditing"
            expand="block" 
            color="danger"
            (click)="deleteUser()">
            üóëÔ∏è Eliminar Usuario
          </ion-button>
        </div>

      </ion-card-content>
    </ion-card>
  </div>

  <!-- Toast personalizado para mensajes -->
  <ion-toast
    [isOpen]="showToast"
    [message]="toastMessage"
    [duration]="3000"
    style="
      --background: #10b981;
      --color: white;
      --box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      --border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
    "
    (didDismiss)="showToast = false">
  </ion-toast>

</ion-content>
